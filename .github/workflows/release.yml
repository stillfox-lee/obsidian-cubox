name: Release Obsidian plugin

on:
  push:
    tags:
      - "*"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ç¡®ä¿ç‰ˆæœ¬ä¿¡æ¯æ­£ç¡®

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18.x"
          cache: 'npm'

      - name: Build plugin
        run: |
          npm install
          npm run build

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${GITHUB_REF#refs/tags/}"
          
          # ç¡®ä¿ç‰ˆæœ¬å·ä¸€è‡´
          plugin_version=$(grep '"version"' manifest.json | cut -d'"' -f4)
          if [ "$tag" != "$plugin_version" ]; then
            echo "Error: Tag version ($tag) does not match plugin version ($plugin_version) in manifest.json"
            exit 1
          fi
          
          # åˆ›å»ºå‘å¸ƒ
          gh release create "$tag" \
            --title="$tag" \
            --draft \
            main.js manifest.json styles.css

      - name: Send Notification
        if: always()
        env:
          NOTIFY_WEBHOOK: ${{ vars.NOTIFY_WEBHOOK }}
        run: |
          tag="${GITHUB_REF#refs/tags/}"
          repo_name="${GITHUB_REPOSITORY#*/}"
          
          # æ ¹æ®ä»»åŠ¡çŠ¶æ€è®¾ç½®æ¶ˆæ¯å†…å®¹
          if [ "${{ job.status }}" = "success" ]; then
            status_emoji="âœ…"
            status_text="æˆåŠŸ"
            button_text="ğŸ” ç¡®è®¤å‘å¸ƒ"
            header_emoji="ğŸ‰"
            template_color="blue"
            action_url="https://github.com/$GITHUB_REPOSITORY/releases/tag/$tag"
          else
            status_emoji="âŒ"
            status_text="å¤±è´¥"
            button_text="ğŸ” æŸ¥çœ‹å¤±è´¥è¯¦æƒ…"
            header_emoji="âš ï¸"
            template_color="red"
            action_url="https://github.com/$GITHUB_REPOSITORY/actions/runs/${{ github.run_id }}"
          fi
          
          # æ„å»ºé£ä¹¦æ¶ˆæ¯
          curl -X POST -H "Content-Type: application/json" -d "{
            \"msg_type\": \"interactive\",
            \"card\": {
              \"schema\": \"2.0\",
              \"config\": {
                \"update_multi\": true,
                \"style\": {
                  \"text_size\": {
                    \"normal_v2\": {
                      \"default\": \"normal\",
                      \"pc\": \"normal\",
                      \"mobile\": \"heading\"
                    }
                  }
                }
              },
              \"body\": {
                \"direction\": \"vertical\",
                \"padding\": \"12px 12px 12px 12px\",
                \"elements\": [
                  {
                    \"tag\": \"markdown\",
                    \"content\": \"ğŸ“¦ **${repo_name}** æ–°ç‰ˆæœ¬ **${tag}** æ„å»º${status_text}\\næ„å»ºçŠ¶æ€ï¼š${status_emoji} ${status_text}\",
                    \"text_align\": \"left\",
                    \"text_size\": \"normal_v2\",
                    \"margin\": \"0px 0px 0px 0px\"
                  },
                  {
                    \"tag\": \"button\",
                    \"text\": {
                      \"tag\": \"plain_text\",
                      \"content\": \"${button_text}\"
                    },
                    \"type\": \"default\",
                    \"width\": \"default\",
                    \"size\": \"medium\",
                    \"behaviors\": [
                      {
                        \"type\": \"open_url\",
                        \"default_url\": \"${action_url}\"
                      }
                    ],
                    \"margin\": \"0px 0px 0px 0px\"
                  }
                ]
              },
              \"header\": {
                \"title\": {
                  \"tag\": \"plain_text\",
                  \"content\": \"${header_emoji} æ’ä»¶æ„å»ºé€šçŸ¥\"
                },
                \"template\": \"${template_color}\",
                \"padding\": \"12px 12px 12px 12px\"
              }
            }
          }" "$NOTIFY_WEBHOOK"